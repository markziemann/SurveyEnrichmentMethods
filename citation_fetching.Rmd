---
title: "Fetch PMC Citation Info"
author: "Mark Ziemann"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Intro

Here we are going to fetch the number of citations as well as the publication date for every PMCID.

The code below fetches the number of times that A PMC has been cited.

The output format is 

1. PMCID

2. PMID

3. Number of cites

4. Pubdate

```{r,library}

library("reutils")
library("XML")
library("kableExtra")
library("anytime")

```

Here are the functions.

You can see that there are tryCatch expressions used to manage the occasional error that are raised by 
eutils queries which I can't reproduce nor debug. 
So for those queries I just attempt again.

```{r,functions}

cites <- function(PMID) {
  tryCatch(
    expr = {
        CITES <- elink(uid=PMID , dbFrom="pubmed", linkname = "pubmed_pubmed_citedin" )
    },
    error = function(e){ 
        CITES <- elink(uid=PMID , dbFrom="pubmed", linkname = "pubmed_pubmed_citedin" )
    },
    finally = {
      return(CITES)
    }
)}
  
get_cites <- function(PMID) {
  CITES <- cites(PMID)
  N_CITES <- length(linkset(CITES)[1]$pubmed_pubmed_citedin)
  return(c(PMID,N_CITES))
}

# test the function
PMID=30763910
res <- get_cites(PMID = PMID)
res

# test a paper with 0 cites
PMID=31148949
res <- get_cites(PMID = PMID)
res

```

## Get cites for small group

Now to get results for a few PMC IDs to test the functions are working OK.

```{r,test1}

PMCIDS <- c("PMC6317205", "PMC6317219", "PMC6318854", "PMC6318897", "PMC6322516", "PMC6323737", "PMC6323741", "PMC6325784", "PMC6325795", "PMC6325889", "PMC6326702", "PMC6327033",
            "PMC6327913", "PMC6328174", "PMC6328465", "PMC6328499", "PMC6329100", "PMC6329100", "PMC6329125", "PMC6329125", "PMC6329193", "PMC6329348")


PMCIDS <- gsub("PMC","",PMCIDS)
es <- esummary(PMCIDS, "pmc",retmode = "json")

es <- content(es, "parsed")
es <- es[2]
es <- es[[1]]
es <- es[2:length(es)]

pmid <- unlist(lapply(es,function(x){
  x$articleids[1,2]
}))

pubdate <- unlist(lapply(es,function(x){
  x$pubdate
}))

df <- data.frame(PMCIDS,pmid,pubdate)

ncites <- t(sapply(df[,2],get_cites))
ncites

df$ncites <- ncites[,2]
head(df)
df <- df[,c(1,2,4,3)]
colnames(df) <- c("PMCID","PMID","NumCites","Pubdate")
df$PMCID <- gsub("^","PMC",df$PMCID)
df$Pubdate <- anydate(df$Pubdate)
df$NumCites <- as.numeric(df$NumCites)
str(df)

df %>% kbl %>% kable_paper("hover", full_width = F)

plot(df$Pubdate,df$NumCites)
mylm <- lm(df$NumCites ~ df$Pubdate)

mylm

```

Looks like it works :)

Except reutils fails for articles with any special characters in there, looks like it is causedby improper handling of non
ASCII characters by the XML parser.
Solution is to use JSON format.

## Get cites for all 

Now to get a bunch of these.

```{r,getcites}

x <- read.table("data/PMC_2019-analysis.tsv",sep="\t",header=TRUE)
head(x)
PMCIDS <- unique(x$Pubmed.Central.ID)

mycitesfunc <- function(PMCIDS) {
  PMCIDS <- gsub("PMC","",PMCIDS)
  es <- esummary(PMCIDS, "pmc",retmode = "json")
  es <- content(es, "parsed")
  es <- es[2]
  es <- es[[1]]
  es <- es[2:length(es)]
  pmid <- unlist(lapply(es,function(x){
    x$articleids[1,2]
  }))
  pubdate <- unlist(lapply(es,function(x){
    x$pubdate
  }))
  df <- data.frame(PMCIDS,pmid,pubdate)
  ncites <- t(sapply(df[,2],get_cites))
  df$ncites <- ncites[,2]
  df <- df[,c(1,2,4,3)]
  colnames(df) <- c("PMCID","PMID","NumCites","Pubdate")
  df$PMCID <- gsub("^","PMC",df$PMCID)
  df$Pubdate <- anydate(df$Pubdate)
  df$NumCites <- as.numeric(df$NumCites)
  return(df)
}

df1 <- mycitesfunc(PMCIDS[1:500])
df2 <- mycitesfunc(PMCIDS[501:1000])
df3 <- mycitesfunc(PMCIDS[1001:1500])

df <- rbind(df1,df2,df3)

df %>% kbl %>% kable_paper("hover", full_width = F)

plot(df$Pubdate,df$NumCites)
mylm <- lm(df$NumCites ~ df$Pubdate)
abline(mylm,col="red")
summary(mylm)
cor.test(df$NumCites , as.numeric(df$Pubdate))
saveRDS(df,"cites_data.rds")

```

## Session information

```{r,sessioninfo}

sessionInfo()

```