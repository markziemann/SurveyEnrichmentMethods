---
title: "PMC Survey Data Analysis"
author: "Mark Ziemann & Kaumadi Wijesooriya"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 5
theme: cosmo
---

## Intro

Here we are performing an analysis of the ways enrichment analysis has been done in a sample of 1500 PMC articles from 2019.

```{r,begin}

knitr::opts_chunk$set(fig.width=7, fig.height=5) 

library("wordcloud")
library("RColorBrewer")
library("wordcloud2")
library("reutils")
library("XML")
library("kableExtra")

```

## Overview of included and excluded analyses

```{r,exclude1}

x <- read.table("PMC_2019-analysis.tsv",header=TRUE,fill=TRUE,sep="\t")
head(x)
colnames(x)
dim(x)

exclude <- subset(x,x$GS.version=="EXCLUDE")
nrow(exclude)
length(unique(exclude$Pubmed.Central.ID))

x <- subset(x,x$GS.version!="EXCLUDE")
nrow(x)
length(unique(x$Pubmed.Central.ID))

```

## Journal 

```{r,Journal1}

journal <- x$Journal
journal_split <- strsplit(journal,", ")
journal <- unlist(journal_split)
res <- table(journal)
res <- res[order(res)]
length(res)
res

par(mar=c(1,1,1,1))
#names(res) <- gsub("Gene expression array","RNA array",names(res))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Journal", xlim=c(0,120))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Journal", xlim=c(0,1200))
grid()

```


## Omics type

```{r,omics1}

omics <- x$Omics.type
omics_split <- strsplit(omics,", ")
omics <- unlist(omics_split)
res <- table(omics)
res <- res[order(res)]
length(res)
res

par(mar=c(1,1,1,1))
names(res) <- gsub("Gene expression array","RNA array",names(res))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Omics type", xlim=c(0,600))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Omics type", xlim=c(0,600))
grid()

```

## Organism

```{r,org1}

org <- x$Organism
org_split <- strsplit(org,", ")
org <- unlist(org_split)
res <- table(org)
res <- res[order(res)]
length(res)
res

par(mar=c(1,1,1,1))
names(res) <- gsub("Homo sapiens","human",names(res))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"), scale=c(4,.5))


par(mar=c(5,12,3,1))
names(res) <- gsub("human","Homo sapiens",names(res))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Organism", xlim=c(0,1200))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Organism", xlim=c(0,1200))
grid()

```

## Gene set library

```{r,gsl1}

GSL <-x$Gene.set.library
GSL_split <- strsplit(GSL,", ")
GSL <- unlist(GSL_split)
res <- table(GSL)
res <- res[order(res)]
length(res)
which(names(res)=="Not stated")/sum(res)*100
res

par(mar=c(1,1,1,1))
names(res) <- gsub("Homo sapiens","human",names(res))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Gene set library", xlim=c(0,1000))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Gene set library", xlim=c(0,500))
grid()

```

## Gene set version

```{r,gsv1}

GSV <-x$GS.version
res <- table(GSV)
res
res[1]/sum(res)*100

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "Gene set version defined", xlim=c(0,1600))
grid()

```

## Statistical test used

```{r,test1}

test <-x$Statistical.test.used
test <- strsplit(test,", ")
test <- unlist(test)
res <- table(test)
res <- res[order(res)]
res[which(names(res)=="Not stated")] / sum(res) * 100
res

par(mar=c(1,1,1,1))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Test used", xlim=c(0,1200))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "Test used", xlim=c(0,1200))
grid()

```

## FDR Correction

```{r,fdr1}

fdr <-x$FDR.Correction
fdr <- strsplit(fdr,", ")
fdr <- unlist(fdr)
res <- table(fdr)
res <- res[order(res)]
sum(res[which(names(res)!="Yes")])/sum(res)*100
res

par(mar=c(1,1,1,1))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "FDR", xlim=c(0,800))
grid()

```


## App used

```{r,app1}

App <-x$App.used
App_split <- strsplit(App,", ")
App <- unlist(App_split)
res <- table(App)
res <- res[order(res)]
res[which(names(res)=="Not stated")]/sum(res)*100
res

par(mar=c(1,1,1,1))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "App used", xlim=c(0,400))
grid()

other <- sum(res[1:(nrow(res)-10)])
res2 <- c(other,tail(res,9))
names(res2)[1] <- "Other"
par(mar=c(5,12,3,1))
barplot(res2,horiz=TRUE,las=1,cex.names = 0.7, xlab="no. analyses",
        main = "App used", xlim=c(0,500))
grid()

```

## App version

```{r,appv1}

APV <-x$App.Version
res <- table(APV)
res
res[1]/sum(res)*100

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "App version defined", xlim=c(0,1600))
grid()

```

## Code available

```{r,code1}

code <-x$Code.availability
res <- table(code)
res
res[1]/sum(res)*100

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "Code availability", xlim=c(0,300))
grid()

```

## Background gene set

```{r,background1}

BG <-x$Background.gene.set
res <- table(BG)
res
sum(res[which(names(res)!="Yes")])/sum(res)*100

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "Background list defined", xlim=c(0,1200))
grid()

```

## Gene lists provided

```{r,genelists1}

GL <-x$Gene.lists.provided
res <- table(GL)
res
sum(res[which(names(res)!="Yes")])/sum(res)*100

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "Gene lists provided", xlim=c(0,1200))
grid()
colnames(x)

```

## Assumptions violated

```{r,assumptions1}

ok <- nrow(subset(x,Assumptions.violated=="No"))
ok
bad <- nrow(subset(x,Assumptions.violated!="No"))
bad
ok/sum(bad,ok)*100

ass <-x$Assumptions.violated
ass <- strsplit(ass,", ")
ass <- unlist(ass)
res <- table(ass)
res <- res[order(res)]
res

par(mar=c(1,1,1,1))
wordcloud(words = names(res), freq = res, min.freq = 1, 
    max.words=200, random.order=FALSE, rot.per=0.35, 
    colors=brewer.pal(8, "Dark2"))

par(mar=c(5,12,3,1))
barplot(tail(res,20),horiz=TRUE,las=1,cex.names = 1, xlab="no. analyses",
        main = "Assumptions violated", xlim=c(0,1400))
grid()

```

## Journal rank

```{r,journal rank}

jmetrics <- read.table("scimagojr_2020.csv",sep=";",header=TRUE,dec = ",")
jmetrics$Title <- toupper(jmetrics$Title)
head(jmetrics)
dim(jmetrics)

nlmcat <- readLines("nlmcatalog_result.txt")
journaltitle <- nlmcat[grep("Title\\(s\\):",nlmcat)]
journaltitle <- gsub("Title\\(s\\): ","",journaltitle)
journaltitle <- gsub("\\.$","",journaltitle)
journaltitle <- toupper(journaltitle) 
head(journaltitle)
head(nlmcat)
journalabbrev <- nlmcat[grep("Title Abbreviation:",nlmcat)]
journalabbrev <- sapply(strsplit(journalabbrev,":"),"[[",2)
journalabbrev <- gsub(" $","",journalabbrev)
journalabbrev <- gsub("^ ","",journalabbrev)
head(journalabbrev)
jdf <- data.frame(journalabbrev,journaltitle)
head(jdf)

mjdf <- merge(jdf,jmetrics,by.x="journaltitle",by.y="Title")
head(mjdf)
dim(mjdf)

xm <- merge(x,mjdf,by.x="Journal",by.y="journalabbrev",all.x = TRUE)
dim(xm)
tail(xm)

```

## Article citations

```{r,cites}


get_pub_date <- function(PMCID) {
  res2 <- esummary(uid=PMCID, db = "pmc")
  res3 <- content(x=res2,as="text")
  res5 <- xmlToList(res3)
  d <- res5$DocumentSummarySet$DocumentSummary$EPubDate
  d <- gsub(" Jan ","-1-",d)
  d <- gsub(" Feb ","-2-",d)
  d <- gsub(" Mar ","-3-",d)
  d <- gsub(" Apr ","-4-",d)
  d <- gsub(" May ","-5-",d)
  d <- gsub(" Jun ","-6-",d)
  d <- gsub(" Jul ","-7-",d)
  d <- gsub(" Aug ","-8-",d)
  d <- gsub(" Sep ","-9-",d)
  d <- gsub(" Oct ","-10-",d)
  d <- gsub(" Nov ","-11-",d)
  d <- gsub(" Dec ","-12-",d)
  return(as.Date(d))
}

get_cites <- function(PMCID) {
  mylink <- elink(uid=PMCID , dbFrom="pmc", dbTo = "pubmed")
  PMID <- mylink[1]
  CITES <- elink(uid = PMID , dbFrom = "pubmed"  , linkname = "pubmed_pubmed_citedin" )
  N_CITES <- length(CITES[1])
  PUBDATE <- get_pub_date(PMCID)
  return(c(PMCID,PMID,N_CITES,PUBDATE))
}

PMCIDS <- as.numeric(gsub("PMC","",x$Pubmed.Central.ID))

# getcites needs to be fixed so that it can handle all the results
PMCIDS <- head(PMCIDS,100)
res <- lapply(X = PMCIDS, FUN = get_cites)
mx <- do.call(rbind,res)
mx <- apply(X = mx, MARGIN = 2, FUN = as.numeric)
df <- as.data.frame(mx)
colnames(df) <- c("PMCID","PMID","NumCites","Pubdate")

df %>% kbl %>% kable_paper("hover", full_width = F)

plot(df$Pubdate,df$NumCites)
mylm <- lm(df$NumCites ~ df$Pubdate)

mylm

```

## Session information

```{r,session}

sessionInfo()

```